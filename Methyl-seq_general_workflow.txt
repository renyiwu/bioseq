#Methyl-seq general workflow:
#R Wu
#Sept 2018

#0.1 Build index for bismark. 
#perl ./Bismark/bismark_genome_preparation /path/to/genomes/Mus_musculus/UCSC/mm10/

#1, sequencing adapter trimming
trim_galore --paired --trim1  sample1_R1.fastq.gz sample1_R2.fastq.gz # for paired-end reads
# or below for single end reads
trim_galore --trim1 sample1_R1.fastq.gz

#2, align reads (fastq files)
#Single end reads
for i in *.fastq.gz; do bismark --multicore 4  --ambiguous --ambig_bam /path/to/genome/ $i; done

# For paired-end reads
bismark --multicore 4  --ambiguous --ambig_bam /path/to/genome/ -1 sample1_R1.fastq.gz -2 sample1_R2.fastq.gz; done


#3, Remove duplicates and extract CpGs.

# Option A. Dedup by Picard. (Recommended)
samtools sort -o sample1.sorted.bam sample1.bam && java -jar /path/to/picard.jar MarkDuplicates I=sample1.sorted.bam O=sample1.rmdup.bam M=sample1.markdup.txt REMOVE_DUPLICATES=true

# Option B. Dedup by Bismark_dedup (Slower than Opthion A)
~/tools/Bismark/deduplicate_bismark -p --output_dir ./ --bam sample*.bam

# Option C. dedup by samtools. (only for single end reads)
samtools sort -o sample1.sorted.bam sample1.bam && samtools rmdup -s sample1.sorted.bam smaple1.rmdup.bam

#4. Extract coverage
samtools view -h sample1.rmdup.bam | python ~/tools/DMRfinder/extract_CpG_data.py -i - -o sample1.cov


#5, combine cov files.
python /path/to/DMRfinder/combine_CpG_sites.py -o combined.csv sample*.cov

#6, DMRfinder
Rscript /path/to/DMRfinder/findDMRs.r -i combined.csv -o combined_dmr.csv -n Control,Model,Treatment sample1,sample2 sample3,sample4 sample5,sample6

#7. Annotation
Rscript /path/to/ChipAnno.r -x /path/to/genes.gtf -i combined_dmr.csv -o combined_dmr_anno.csv



#############
# Bismark on github
https://github.com/FelixKrueger/Bismark

# DMRfinder on github
https://github.com/jsh58/DMRfinder

# ChipAnno.r on github
https://github.com/renyiwu/bioseq/blob/master/ChipAnno.r

